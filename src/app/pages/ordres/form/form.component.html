<div class="form-ordres-page">
  <div
    class="form-scrollTo-buttons-container"
    [ngClass]="{ width0: !leftAccessPanel?.value }"
  >
    <div class="form-scrollTo-buttons-subcontainer">
      <span class="top-order-number">{{ this?.ordre?.numero || "-" }}</span>
      <dx-button
        class="black scrollTo-buttons"
        data-accordion="articles"
        height="auto"
        icon="box"
        text="{{ 'ordres-suivi-articles' | localize }}"
        [routerLink]="[]"
        [queryParamsHandling]="'merge'"
        [fragment]="fragments.Articles"
      >
      </dx-button>
      <dx-button
        class="black scrollTo-buttons"
        data-accordion="logistique"
        height="auto"
        icon="material-icons local_shipping"
        text="{{ 'ordres-suivi-logistique' | localize }}"
        [routerLink]="[]"
        [queryParamsHandling]="'merge'"
        [fragment]="fragments.Logistique"
      >
      </dx-button>
      <div class="button-container">
        <div
          *ngIf="dotLitiges"
          class="dot"
        >
          {{ dotLitiges }}
        </div>
        <div
          *ngIf="!dotLitiges && ordre && !!gridCommandes?.gridRowsTotal"
          (click)="onClickCreateLitige()"
          class="add-litige-button dx-datagrid-addrow-button dx-button dx-button-mode-text dx-button-has-icon dx-button-has-text"
          title="{{ 'ordres-litiges-create' | localize }}"
        >
          <div class="dx-button-content">
            <i class="dx-icon dx-icon-edit-button-addrow"></i>
          </div>
        </div>
        <dx-button
          #litigesBtn
          class="black dotted-button scrollTo-buttons"
          data-accordion="litiges"
          height="auto"
          icon="material-icons offline_bolt"
          [routerLink]="[]"
          [queryParamsHandling]="'merge'"
          [fragment]="fragments.Litiges"
          text="{{ 'ordres-suivi-litiges' | localize }}"
        >
        </dx-button>
      </div>
      <dx-button
        class="black scrollTo-buttons"
        data-accordion="synthese"
        height="auto"
        icon="material-icons euro_symbol"
        [routerLink]="[]"
        [queryParamsHandling]="'merge'"
        [fragment]="fragments.Synthese"
        text="{{ 'ordres-suivi-synthese' | localize }}"
      >
      </dx-button>
      <dx-button
        class="black scrollTo-buttons"
        height="auto"
        data-accordion="fluxdocs"
        icon="material-icons folder"
        [routerLink]="[]"
        [queryParamsHandling]="'merge'"
        [fragment]="fragments.Flux"
        text="{{ 'ordres-suivi-fluxdocs' | localize }}"
      >
      </dx-button>
      <div class="button-container">
        <div
          *ngIf="dotCQ"
          class="dot"
        >
          {{ dotCQ }}
        </div>
        <dx-button
          class="black dotted-button scrollTo-buttons"
          data-accordion="CQ"
          height="auto"
          icon="material-icons insert_chart_outlined"
          [routerLink]="[]"
          [queryParamsHandling]="'merge'"
          [fragment]="fragments.CQ"
          text="{{ 'ordres-suivi-CQ' | localize }}"
        >
        </dx-button>
      </div>
      <div class="button-container">
        <div
          *ngIf="dotCommentaires"
          class="dot"
        >
          {{ dotCommentaires }}
        </div>
        <dx-button
          class="black dotted-button scrollTo-buttons"
          data-accordion="commentaires"
          height="auto"
          icon="material-icons message"
          [routerLink]="[]"
          [queryParamsHandling]="'merge'"
          [fragment]="fragments.Commentaires"
          text="{{ 'ordres-suivi-commentaires' | localize }}"
        >
        </dx-button>
      </div>
      <dx-button
        class="black scrollTo-buttons"
        data-accordion="log"
        height="auto"
        icon="material-icons view_headline"
        [routerLink]="[]"
        [queryParamsHandling]="'merge'"
        [fragment]="fragments.Log"
        text="{{ 'ordres-suivi-log' | localize }}"
      >
      </dx-button>
      <dx-button
        class="black scrollTo-buttons"
        height="auto"
        icon="material-icons folder"
        [disabled]="!ordre"
        (onClick)="fileManagerClick()"
        text="{{ 'ordres-suivi-documents' | localize }}"
      >
      </dx-button>
    </div>
  </div>
  <form [formGroup]="formGroup">
    <dx-validation-group name="loginGroup">
      <div class="content-block"></div>
      <div
        class="ordres-page"
        [ngClass]="{ 'ordres-page-fullscreen': !leftAccessPanel?.value }"
      >
        <dx-box direction="row">
          <dxi-item [ratio]="8">
            <div class="top-panel-order">
              <dx-load-indicator
                [visible]="!fullOrderNumber"
                class="order-loader"
              ></dx-load-indicator>
              <div class="order-number">{{ fullOrderNumber }}</div>
              <dx-button
                class="order-reload-btn"
                [visible]="!linkedOrdersSearch && !!fullOrderNumber"
                type="default"
                [focusStateEnabled]="false"
                hint="{{ 'hint-click-reload-ordre' | localize }}"
                icon="material-icons refresh"
                (onClick)="refreshOrder()"
              >
              </dx-button>
              <div class="linkedOrders-container">
                <div class="linkedOrders-subcontainer">
                  <span
                    *ngIf="linkedOrdersSearch"
                    class="search-linkedOrders"
                    >Recherche ordres liés...</span
                  >
                  <dx-button
                    *ngFor="let linkedOrder of linkedOrders"
                    class="small-button linkedOrder-{{ linkedOrder.class }}"
                    type="default"
                    hint="{{ 'hint-access-ordre' | localize }}"
                    text="{{ linkedOrder.ordre.numero }} ({{
                      linkedOrder.criteria
                    }})"
                    (onClick)="openLinkedOrder(linkedOrder.ordre)"
                  >
                  </dx-button>
                </div>
              </div>
              <div class="upperButtons-container">
                <dx-button
                  class="upperButton"
                  type="danger"
                  [disabled]="ordreBAFOuFacture || !fullOrderNumber"
                  text="{{ 'btn-deleteorder' | localize }}"
                  (onClick)="onDeleteOrderClick()"
                ></dx-button>
                <dx-button
                  class="upperButton"
                  type="danger"
                  [disabled]="
                    ordreFacture || !fullOrderNumber || cancelledOrder
                  "
                  hint="{{ 'hint-cancelorder' | localize }}"
                  text="{{ 'btn-cancelorder' | localize }}"
                  (onClick)="onCancelOrderClick()"
                ></dx-button>
                <dx-button
                  class="upperButton"
                  type="default"
                  [disabled]="!fullOrderNumber"
                  text="{{ 'btn-cloneorder' | localize }}"
                  [disabled]="!canDuplicate"
                  (onClick)="onDuplicateOrderClick()"
                ></dx-button>
                <dx-button
                  class="upperButton"
                  type="default"
                  [disabled]="!fullOrderNumber"
                  text="{{ 'btn-complorder' | localize }}"
                  (onClick)="onComplOrderClick()"
                ></dx-button>
              </div>
            </div>
            <div class="order-tabs">
              <div
                #anchor
                [attr.data-fragment-id]="fragments.Head"
                class="dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <span class="dx-form-group-caption">{{
                  "ordres-suivi-groupe-infos" | localize
                }}</span>

                <!-- separator -->
                <span> - </span>

                <span
                  *ngIf="ordre"
                  class="dx-form-group-caption red-font-imp"
                  >{{ status }}</span
                >

                <span *ngIf="ordreFacture && numeroFacture?.length"
                  >&nbsp;&nbsp;&nbsp;</span
                >
                <dx-button
                  *ngIf="ordreFacture && numeroFacture?.length"
                  class="small-button facture-btn"
                  type="danger"
                  hint="{{ 'hint-ordres-factures' | localize }}"
                  text="Fact. {{ numeroFacture }}"
                  (onClick)="
                    viewFacture(
                      'ordres-view-facture-title',
                      ordre.documentFacture
                    )
                  "
                >
                </dx-button>
                <span
                  *ngIf="!!refOrdreEdi"
                  class="edi-order-ref"
                  >{{ canalOrdreEdi }} : {{ refOrdreEdi }}</span
                >
                <dx-check-box
                  #leftAccessPanel
                  class="float-right leftPanelCheckBox"
                  hint="{{
                    (leftAccessPanel.value ? 'masquer' : 'afficher') +
                      '-boutons-navigation-rapide' | localize
                  }}"
                  (onValueChanged)="leftPanelChange($event)"
                >
                </dx-check-box>
                <span
                  *ngIf="refOrdre"
                  class="order-id"
                  >&nbsp;&nbsp;{{ "ordres-ref" | localize }} :
                  {{ refOrdre }}</span
                >
                <dx-button
                  class="header-btn-baf float-right"
                  type="default"
                  [visible]="showBAFButton && !!fullOrderNumber"
                  text="Bon à facturer"
                  (onClick)="bonAFacturer()"
                ></dx-button>
                <div
                  class="duplication-buk-container header-btn-baf float-right"
                  [hidden]="hideDuplicationBUK"
                >
                  <dx-button
                    type="default"
                    class="duplicateBUKSA-btn"
                    [disabled]="!fullOrderNumber"
                    [text]="'Duplication vers SA'"
                    (onClick)="onDuplicationBukSaClick()"
                  ></dx-button>
                  <dx-button
                    type="default"
                    class="duplicateBUKSA-btn-trash"
                    [disabled]="!fullOrderNumber"
                    [icon]="'trash'"
                    hint="{{ 'hint-suppression-regroupement' | localize }}"
                    (onClick)="onDelRegroupementClick()"
                  ></dx-button>
                </div>
                <div style="clear: both"></div>
                <div
                  class="dx-form-group-content no-padding-bottom order-header"
                >
                  <dx-load-panel
                    #loadPanel
                    [position]="{ of: '#head' }"
                    [visible]="headerSaving || headerRefresh"
                    [showPane]="true"
                    [shading]="false"
                    [hideOnOutsideClick]="false"
                  >
                  </dx-load-panel>
                  <dx-box>
                    <dxi-item [ratio]="4">
                      <!-- Client -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-client" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-select-box
                            [readOnly]="true"
                            formControlName="client"
                            [dataSource]="clientsDS"
                            [displayExpr]="displayCodeBefore"
                            [searchExpr]="['id']"
                          >
                            <dx-validator
                              name="{{ 'ordres-client' | localize }}"
                            >
                              <dxi-validation-rule
                                type="required"
                              ></dxi-validation-rule>
                            </dx-validator>
                          </dx-select-box>
                        </div>
                        <dx-button
                          class="form-zoom-button rightPositioned"
                          type="default"
                          icon="material-icons search"
                          [focusStateEnabled]="false"
                          hint="{{ 'hint-click-file' | localize }}"
                          (onClick)="openClientFilePopup()"
                        >
                        </dx-button>
                      </div>
                      <!-- Entrepôt livré -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-entrepotLivre" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-select-box
                            [readOnly]="true"
                            formControlName="entrepot"
                            [dataSource]="entrepotDS"
                            [displayExpr]="displayCodeBefore"
                          >
                            <dx-validator
                              name="{{ 'ordres-entrepotLivre' | localize }}"
                            >
                              <dxi-validation-rule
                                type="required"
                              ></dxi-validation-rule>
                            </dx-validator>
                          </dx-select-box>
                        </div>
                        <dx-button
                          class="entrepot-change-button rightPositioned"
                          type="default"
                          icon="material-icons swap_horiz"
                          [focusStateEnabled]="false"
                          [visible]="!ordreBAFOuFacture"
                          hint="{{ 'hint-entrep-change' | localize }}"
                          (onClick)="openChoixEntrepotPopup()"
                        >
                        </dx-button>
                        <dx-button
                          class="form-zoom-button rightPositioned"
                          type="default"
                          icon="material-icons search"
                          [focusStateEnabled]="false"
                          hint="{{ 'hint-click-file' | localize }}"
                          (onClick)="openEntrepotFilePopup()"
                        >
                        </dx-button>
                      </div>
                      <!-- Réf Client -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-referenceClient" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-text-box formControlName="referenceClient">
                            <dx-validator
                              name="{{ 'ordres-referenceClient' | localize }}"
                            >
                              <dxi-validation-rule
                                type="stringLength"
                                [max]="70"
                                [trim]="false"
                              ></dxi-validation-rule>
                            </dx-validator>
                          </dx-text-box>
                        </div>
                      </div>
                      <!-- Date départ -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-dateDepartPrevue" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-date-box
                            [readOnly]="ordreFacture"
                            formControlName="dateDepartPrevue"
                            [displayFormat]="'dd-MM-yy HH:mm (EEEE)'"
                            dateSerializationFormat="yyyy-MM-ddTHH:mm:ss"
                            type="datetime"
                          >
                            <dx-validator
                              name="{{ 'ordres-dateDepartPrevue' | localize }}"
                            >
                              <dxi-validation-rule
                                type="required"
                              ></dxi-validation-rule>
                            </dx-validator>
                          </dx-date-box>
                        </div>
                      </div>
                      <!-- Date livraison -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-dateLivraisonPrevue" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-date-box
                            [readOnly]="ordreFacture"
                            formControlName="dateLivraisonPrevue"
                            [displayFormat]="'dd-MM-yy HH:mm (EEEE)'"
                            dateSerializationFormat="yyyy-MM-ddTHH:mm:ss"
                            type="datetime"
                          >
                            <dx-validator
                              name="{{
                                'ordres-dateLivraisonPrevue' | localize
                              }}"
                            >
                              <dxi-validation-rule
                                type="required"
                              ></dxi-validation-rule>
                            </dx-validator>
                          </dx-date-box>
                        </div>
                        <dx-button
                          [visible]="canChangeDateLiv && !!fullOrderNumber"
                          stylingMode="text"
                          class="form-zoom-button rightPositioned"
                          type="default"
                          icon="material-icons edit"
                          [focusStateEnabled]="false"
                          hint="{{ 'hint-click-change-date' | localize }}"
                          (onClick)="openDateChangePopup()"
                        >
                        </dx-button>
                      </div>
                      <!-- incoterms -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-incoterm" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-select-box
                            [readOnly]="ordreFacture"
                            formControlName="incoterm"
                            [dataSource]="incotermsDS"
                            [displayExpr]="displayIDBefore"
                            [searchExpr]="['id']"
                          >
                            <dx-validator
                              name="{{ 'ordres-incoterm' | localize }}"
                            >
                              <!-- <dxi-validation-rule
                                type="required"
                              ></dxi-validation-rule> -->
                            </dx-validator>
                          </dx-select-box>
                        </div>
                      </div>
                      <dx-box>
                        <dxi-item [ratio]="5">
                          <!-- Transport -->
                          <div class="dx-field field-large">
                            <div class="dx-field-label">
                              {{ "ordres-transporteur" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-select-box
                                [readOnly]="ordreFacture"
                                formControlName="transporteur"
                                [dataSource]="transporteursDS"
                                [displayExpr]="displayIDBefore"
                                [showClearButton]="true"
                                [searchExpr]="['id']"
                              >
                                <dxo-drop-down-options [width]="400">
                                </dxo-drop-down-options>
                                <dx-validator
                                  name="{{ 'ordres-transporteur' | localize }}"
                                >
                                  <dxi-validation-rule
                                    type="required"
                                  ></dxi-validation-rule>
                                </dx-validator>
                              </dx-select-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item
                          [ratio]="0.5"
                          [baseSize]="10"
                        >
                          <dx-button
                            class="form-zoom-button"
                            type="default"
                            icon="material-icons search"
                            [focusStateEnabled]="false"
                            hint="{{ 'hint-click-file' | localize }}"
                            (onClick)="openTransporteurFilePopup()"
                          >
                          </dx-button>
                        </dxi-item>
                        <dxi-item [ratio]="4">
                          <!-- Type -->
                          <div class="dx-field field-small">
                            <div class="dx-field-label">
                              {{ "ordres-typeTransport" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-select-box
                                [readOnly]="ordreFacture"
                                formControlName="typeTransport"
                                [dataSource]="typeTransportDS"
                                [displayExpr]="displayIDBefore"
                                [searchExpr]="['id']"
                              >
                                <dxo-drop-down-options [width]="400">
                                </dxo-drop-down-options>
                                <!-- <dx-validator name="{{ 'ordres-typeTransport' | localize }}">
                                              <dxi-validation-rule type="required"></dxi-validation-rule>
                                          </dx-validator> -->
                              </dx-select-box>
                            </div>
                          </div>
                        </dxi-item>
                      </dx-box>
                      <dx-box>
                        <dxi-item [ratio]="3">
                          <!-- PU -->
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{
                                "ordres-prixUnitaireTarifTransport" | localize
                              }}
                            </div>
                            <div class="dx-field-value">
                              <dx-number-box
                                [readOnly]="ordreFacture"
                                class="alignright"
                                formControlName="transporteurDEVPrixUnitaire"
                                [format]="'#0.00'"
                              >
                                <!-- <dx-validator name="{{ 'ordres-prixUnitaireTarifTransport' | localize }}">
                                        <dxi-validation-rule type="required"></dxi-validation-rule>
                                    </dx-validator> -->
                              </dx-number-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item [ratio]="2">
                          <!-- Devise -->
                          <div class="dx-field field-small">
                            <div class="dx-field-label">
                              {{ "ordres-transporteurDEVCode" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-select-box
                                [readOnly]="ordreFacture"
                                formControlName="transporteurDEVCode"
                                [dataSource]="deviseDS"
                                [displayExpr]="displayIDBefore"
                                [searchExpr]="['id']"
                              >
                                <dxo-drop-down-options [width]="400">
                                </dxo-drop-down-options>
                                <!-- <dx-validator name="{{ 'ordres-transporteurDEVCode' | localize }}">
                                      <dxi-validation-rule type="required"></dxi-validation-rule>
                                  </dx-validator> -->
                              </dx-select-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item [ratio]="1"></dxi-item>
                        <dxi-item [ratio]="6">
                          <!-- Unité (Base tarif transport) -->
                          <div class="dx-field field-small">
                            <div class="dx-field-label">
                              {{ "ordres-baseTarifTransport" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-select-box
                                [readOnly]="ordreFacture"
                                formControlName="baseTarifTransport"
                                [dataSource]="baseTarifTransportDS"
                                [displayExpr]="displayIDBefore"
                                [searchExpr]="['id']"
                              >
                                <dxo-drop-down-options [width]="400">
                                </dxo-drop-down-options>
                              </dx-select-box>
                            </div>
                          </div>
                        </dxi-item>
                      </dx-box>
                      <!-- Instructions Logistique -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-instructionsLogistiques" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-select-box
                            #comLog
                            [readOnly]="ordreFacture"
                            formControlName="instructionsLogistiques"
                            [acceptCustomValue]="true"
                            (onValueChanged)="onComChanged()"
                            [items]="instructionsList"
                          >
                            <dxo-drop-down-options [width]="600">
                            </dxo-drop-down-options>
                            <dx-validator
                              name="{{
                                'ordres-instructionsLogistiques' | localize
                              }}"
                            >
                              <dxi-validation-rule
                                type="stringLength"
                                [max]="280"
                              ></dxi-validation-rule>
                            </dx-validator>
                          </dx-select-box>
                        </div>
                      </div>
                      <!-- Comm interne -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-commentaireUsageInterne" | localize }}
                        </div>
                        <div class="dx-field-value small-font">
                          <dx-text-box
                            #comInt
                            [readOnly]="ordreFacture"
                            formControlName="commentaireUsageInterne"
                            (onValueChanged)="onComChanged()"
                          >
                            <dx-validator
                              name="{{
                                'ordres-commentaireUsageInterne' | localize
                              }}"
                            >
                              <dxi-validation-rule
                                type="stringLength"
                                [max]="128"
                              ></dxi-validation-rule>
                            </dx-validator>
                          </dx-text-box>
                        </div>
                      </div>
                      <dxi-item [ratio]="9">
                        <!-- Mention regime TVA -->
                        <div class="dx-field red-font info-supp-tva">
                          {{ mentionRegimeTva | async }}
                        </div>
                      </dxi-item>
                      <dxi-item [ratio]="9">
                        <!-- Descriptif regroupement -->
                        <div
                          *ngIf="descriptifRegroupement"
                          class="dx-field desc-regroup"
                        >
                          {{ descriptifRegroupement }}
                        </div>
                      </dxi-item>
                    </dxi-item>

                    <dxi-item [ratio]="0.4"></dxi-item>

                    <dxi-item [ratio]="4">
                      <dx-box>
                        <dxi-item [ratio]="6">
                          <!-- Code Chargement -->
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{ "ordres-codeChargement" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-text-box
                                formControlName="codeChargement"
                                [readOnly]="ordreFacture"
                              >
                              </dx-text-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item [ratio]="0.1"></dxi-item>
                        <dxi-item
                          [ratio]="2"
                          style="max-width: 156px"
                        >
                          <dx-button
                            class="form-text-button"
                            type="default"
                            [disabled]="!ordre?.codeChargement"
                            text="{{ 'grouper-chargements' | localize }}"
                            [focusStateEnabled]="false"
                            hint="{{ 'hint-group-order-lines' | localize }}"
                            (onClick)="openGroupageChargementsPopup()"
                          >
                          </dx-button>
                        </dxi-item>
                      </dx-box>

                      <dx-box>
                        <dxi-item [ratio]="3">
                          <!-- Date départ -->
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{ "ordres-ETDDate" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-date-box
                                [readOnly]="ordreFacture"
                                formControlName="etdDate"
                                [displayFormat]="'dd-MM-yy (EEEE)'"
                                dateSerializationFormat="yyyy-MM-dd"
                                type="date"
                              >
                              </dx-date-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item [ratio]="0.5"></dxi-item>
                        <dxi-item [ratio]="5">
                          <!-- Lieu départ ETDLocation -->
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{ "ordres-portTypeD" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-select-box
                                formControlName="portTypeD"
                                [readOnly]="ordreFacture"
                                [dataSource]="portTypeDDS"
                                displayExpr="name"
                                [searchExpr]="['name']"
                              >
                                <dxo-drop-down-options [width]="400">
                                </dxo-drop-down-options>
                              </dx-select-box>
                            </div>
                          </div>
                        </dxi-item>
                      </dx-box>
                      <dx-box>
                        <dxi-item [ratio]="3">
                          <!-- Date arrivée -->
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{ "ordres-ETADate" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-date-box
                                formControlName="etaDate"
                                [readOnly]="ordreFacture"
                                [displayFormat]="'dd-MM-yy (EEEE)'"
                                dateSerializationFormat="yyyy-MM-dd"
                                type="date"
                              >
                              </dx-date-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item [ratio]="0.5"></dxi-item>
                        <dxi-item [ratio]="5">
                          <!-- Lieu arrivée ETALocation -->
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{ "ordres-portTypeA" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-select-box
                                formControlName="portTypeA"
                                [readOnly]="ordreFacture"
                                [dataSource]="portTypeADS"
                                displayExpr="name"
                                [searchExpr]="['name']"
                              >
                                <dxo-drop-down-options [width]="400">
                                </dxo-drop-down-options>
                              </dx-select-box>
                            </div>
                          </div>
                        </dxi-item>
                      </dx-box>

                      <!-- Lieu Incoterm -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-incotermLieu" | localize }}
                        </div>
                        <div class="dx-field-value small-font">
                          <dx-text-box
                            formControlName="incotermLieu"
                            [readOnly]="ordreFacture"
                          >
                          </dx-text-box>
                        </div>
                      </div>

                      <!-- Devise et taux-->
                      <dx-box>
                        <dxi-item [ratio]="3">
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{ "ordres-devise" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-select-box
                                formControlName="devise"
                                [readOnly]="true"
                                [dataSource]="deviseDS"
                                [displayExpr]="displayIDBefore"
                              >
                              </dx-select-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item [ratio]="0.5"></dxi-item>
                        <dxi-item [ratio]="3">
                          <div class="dx-field">
                            <div class="dx-field-label">
                              {{ "ordres-taux" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-number-box
                                formControlName="tauxDevise"
                                [readOnly]="true"
                                [format]="{
                                  type: 'fixedPoint',
                                  precision: 5
                                }"
                              >
                              </dx-number-box>
                            </div>
                          </div>
                        </dxi-item>
                      </dx-box>

                      <!-- commercial -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-commercial" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-select-box
                            formControlName="commercial"
                            [readOnly]="ordreFacture"
                            [dataSource]="commercialDS"
                            [displayExpr]="displayIDBefore"
                            [searchExpr]="['id', 'nomUtilisateur']"
                          >
                            <dx-validator
                              name="{{ 'ordres-commercial' | localize }}"
                            >
                              <!-- <dxi-validation-rule
                                type="required"
                              ></dxi-validation-rule> -->
                            </dx-validator>
                          </dx-select-box>
                        </div>
                      </div>
                      <!-- assistante -->
                      <div class="dx-field">
                        <div class="dx-field-label">
                          {{ "ordres-assistante" | localize }}
                        </div>
                        <div class="dx-field-value">
                          <dx-select-box
                            formControlName="assistante"
                            [readOnly]="ordreFacture"
                            [dataSource]="assistanteDS"
                            [displayExpr]="displayIDBefore"
                            [searchExpr]="['id', 'nomUtilisateur']"
                          >
                            <dx-validator
                              name="{{ 'ordres-assistante' | localize }}"
                            >
                              <!-- <dxi-validation-rule
                                type="required"
                              ></dxi-validation-rule> -->
                            </dx-validator>
                          </dx-select-box>
                        </div>
                      </div>

                      <dx-box>
                        <dxi-item [ratio]="4">
                          <!-- Vente Commission -->
                          <div class="dx-field field-large">
                            <div class="dx-field-label checkbox-label">
                              {{ "ordres-venteACommission" | localize }}
                            </div>
                            <div class="dx-field-value">
                              <dx-check-box
                                [disabled]="!allowVenteACommissionMutation"
                                formControlName="venteACommission"
                              >
                              </dx-check-box>
                            </div>
                          </div>
                        </dxi-item>
                        <dxi-item [ratio]="1"></dxi-item>
                        <dxi-item [ratio]="4"> </dxi-item>
                      </dx-box>
                      <dx-box>
                        <dxi-item [ratio]="9">
                          <!-- CHEP et frais client -->
                          <div class="dx-field red-font info-supp">
                            {{ gestEntrepot }}<br />{{ fraisClient }}
                          </div>
                          <!-- Instructions internes -->
                          <div class="dx-field blue-font info-supp">
                            {{ instructionsComm }}
                          </div>
                          <!-- Depassement client -->
                          <div
                            *ngIf="ordre?.client?.depassement > 0"
                            class="dx-field dep-en-cours"
                          >
                            Dépassement client :
                            {{
                              gridUtilsService.numberWithSpaces(
                                ordre?.client?.depassement
                              )
                            }}
                            {{ ordre?.client?.devise?.id }}
                          </div>
                        </dxi-item>
                      </dx-box>

                      <!-- <dx-box>
                              <dxi-item [ratio]="4">
                              </dxi-item>
                              <dxi-item [ratio]="1"></dxi-item>
                              <dxi-item [ratio]="4">
                              </dxi-item>
                          </dx-box> -->
                    </dxi-item>
                  </dx-box>
                </div>
              </div>

              <div
                #anchor
                [attr.data-fragment-id]="fragments.Articles"
                class="articles-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <span class="dx-form-group-caption">{{
                  "ordres-suivi-groupe-articles" | localize
                }}</span>

                <dx-button
                  class="upperButton subButton edi-colibri-button"
                  [ngClass]="{
                    'inactive-button':
                      !fullOrderNumber ||
                      !authService.currentUser.accessCommandeEdi
                  }"
                  [visible]="!!refOrdreEdi"
                  type="success"
                  text="{{ 'btn-show-order' | localize }} {{ canalOrdreEdi }}"
                  (onClick)="onShowEdiColibriOrderClick()"
                ></dx-button>

                <div class="action-article-container">
                  <app-add-article-to-order-buttons
                    *ngIf="!refOrdreEdi"
                    [gridCommandesAlias]="gridCommandes"
                    [articleRowKeyAlias]="articleRowKey"
                    [singleAlias]="false"
                    [fullOrderNumberAlias]="fullOrderNumber"
                    [allowMutationsAlias]="allowMutations"
                    [histoLigneOrdreTextAlias]="histoLigneOrdreText"
                    [histoLigneOrdreROTextAlias]="histoLigneOrdreReadOnlyText"
                    [ordreAlias]="ordre"
                    (lignesChanged)="onLignesChanged($event)"
                  >
                  </app-add-article-to-order-buttons>
                </div>

                <dx-button
                  class="upperButton subButton shiftedRight"
                  [disabled]="!fullOrderNumber"
                  type="default"
                  height="36"
                  [focusStateEnabled]="false"
                  icon="material-icons info"
                  text="{{
                    (ordresLignesViewExp ? 'btn-ordreLignes' : 'btn-detailExp')
                      | localize
                  }}"
                  (onClick)="detailExp()"
                ></dx-button>
                <div style="clear: both"></div>
                <div class="dx-form-group-content">
                  <div
                    class="top-grid-cde-buttons"
                    [hidden]="!gridCommandes?.gridRowsTotal"
                  >
                    <!-- Confirmation de l'ordre -->
                    <app-actions-documents-ordres
                      [ordre]="ordre"
                      [gridEnvois]="gridEnvois"
                      [gridCommandes]="gridCommandes"
                      [orderConfirmationOnly]="true"
                    ></app-actions-documents-ordres>
                    <!-- Ordre de régularisation -->
                    <dx-button
                      class="order-regul-button"
                      type="default"
                      [focusStateEnabled]="false"
                      text="{{ 'btn-regulorder' | localize }}"
                      hint="{{ 'hint-regulorder' | localize }} "
                      (onClick)="onRegulOrderClick()"
                    ></dx-button>
                    <!-- Destockage auto -->
                    <dx-button
                      class="stock-auto-button"
                      type="success"
                      [focusStateEnabled]="false"
                      text="{{ 'btn-stockauto' | localize }}"
                      hint="{{ 'hint-stockauto' | localize }} "
                      (onClick)="onDestockAutoClick()"
                    ></dx-button>
                    <!-- Ajout article(s) dans les réfs client -->
                    <dx-button
                      class="add-ref-client-button"
                      type="default"
                      [focusStateEnabled]="false"
                      [disabled]="!selectedGridCdesRows"
                      text="{{ 'btn-addrefclt' | localize }}"
                      [hint]="
                        ((vowelTest(ordre?.client?.code)
                          ? 'hint-addrefclt2'
                          : 'hint-addrefclt'
                        ) | localize) + ordre?.client?.code
                      "
                      (onClick)="onAddRefsClient()"
                    ></dx-button>
                  </div>
                  <app-grid-commandes
                    *ngIf="ordre?.id"
                    [ordre]="ordre"
                    [venteACommission]="ordre?.venteACommission"
                    (swapRowArticle)="onArticleManClick($event)"
                    (priceChange)="refreshRegimeTva.emit()"
                    (transporteurChange)="refreshTransporteur()"
                    (selectedRowsChange)="gridCdesSelectedRowsChange($event)"
                    (updateDestockAuto)="updateDestockAuto()"
                    (afterSaved)="refreshHeader()"
                    (closeFormAccordions)="closeFormAccordions($event)"
                    (openAfterStandByAccordions)="
                      openAfterStandByAccordions($event)
                    "
                  ></app-grid-commandes>
                  <div class="grid-separator"></div>
                  <app-grid-ordre-ligne-logistique
                    #gridLignesLogistique
                    (refreshGridLigneDetail)="refreshGridLigneDetail($event)"
                    [ordre]="ordre"
                    [ordreBAFOuFacture]="ordreBAFOuFacture"
                    [gridCommandes]="gridCommandes"
                  ></app-grid-ordre-ligne-logistique>
                  <div *ngIf="ordresLignesViewExp">
                    <div class="grid-separator"></div>
                    <app-grid-lignes-details
                      [ordre]="ordre"
                      (refreshGridsSynthese)="refreshGridsSynthese()"
                    ></app-grid-lignes-details>
                  </div>
                </div>
              </div>

              <div
                class="logistique-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <dx-accordion
                  #anchor
                  [disabled]="!ordre?.id"
                  [attr.data-fragment-id]="fragments.Logistique"
                  data-name="logistique"
                  [collapsible]="true"
                  [multiple]="false"
                  [selectedIndex]="-1"
                  [dataSource]="[ordre]"
                  (onItemClick)="onAccordionToggleBtnClick($event)"
                >
                  <div *dxTemplate="let prop of 'title'">
                    <span class="dx-form-group-caption accordion-title">{{
                      "ordres-suivi-groupe-logistique" | localize
                    }}</span>
                  </div>
                  <div *dxTemplate="let data of 'item'">
                    <div class="dx-form-group-content log-transp">
                      <div class="dx-form-group-content">
                        <!-- transporteur -->
                        <div class="dx-field">
                          <div class="dx-field-label">
                            {{ "ordres-transporteur" | localize }}
                          </div>
                          <div class="dx-field-value">
                            <dx-select-box
                              formControlName="transporteur"
                              [dataSource]="transporteursDS"
                              [displayExpr]="displayIDBefore"
                              [readOnly]="true"
                              [searchExpr]="['id']"
                            >
                            </dx-select-box>
                          </div>
                        </div>
                        <br />
                      </div>
                    </div>
                    <app-grid-logistiques
                      [gridLignesLogistique]="gridLignesLogistique"
                      [gridCommandes]="gridCommandes"
                      [ordre]="data"
                    ></app-grid-logistiques>
                    <div class="grid-separator"></div>
                    <app-grid-frais [ordre]="data"></app-grid-frais>
                  </div>
                </dx-accordion>
              </div>

              <div
                class="litiges-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <dx-accordion
                  #anchor
                  [disabled]="!ordre?.id"
                  [attr.data-fragment-id]="fragments.Litiges"
                  data-name="litiges"
                  [collapsible]="true"
                  [multiple]="false"
                  [selectedIndex]="-1"
                  [dataSource]="[ordre]"
                  (onItemClick)="onAccordionToggleBtnClick($event)"
                >
                  <div *dxTemplate="let prop of 'title'">
                    <span class="dx-form-group-caption accordion-title">{{
                      "ordres-suivi-groupe-litiges" | localize
                    }}</span>
                  </div>
                  <div *dxTemplate="let data of 'item'">
                    <app-form-litiges
                      #formLitiges
                      [ordre]="data"
                      [gridCdeHasRows]="!!gridCommandes?.gridRowsTotal"
                      [grid]="gridLitigesLignes"
                      [selectedLitigeLigneKey]="
                        gridLitigesLignes.getFocusedRowKey()
                      "
                      (litigeCreated)="refreshLitigeIndicator()"
                    ></app-form-litiges>
                    <app-grid-litiges-lignes
                      #gridLitigesLignes
                      [hidden]="!formLitiges.infosLitige"
                      [ordre]="data"
                      (litigeLigneSelected)="formLitiges.modifierLot()"
                    >
                    </app-grid-litiges-lignes>
                  </div>
                </dx-accordion>
              </div>

              <div
                class="synthese-field accordion3 dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <dx-accordion
                  #anchor
                  [disabled]="!ordre?.id"
                  [attr.data-fragment-id]="fragments.Synthese"
                  data-name="synthese"
                  [collapsible]="true"
                  [multiple]="false"
                  [selectedIndex]="-1"
                  [dataSource]="[ordre]"
                  (onItemClick)="onAccordionToggleBtnClick($event)"
                >
                  <div *dxTemplate="let prop of 'title'">
                    <span class="dx-form-group-caption accordion-title">{{
                      "ordres-suivi-groupe-synthese" | localize
                    }}</span>
                  </div>
                  <div *dxTemplate="let data of 'item'">
                    <div class="dx-form-group-content">
                      <div class="grid-marge-container">
                        <dx-button
                          class="margin-btn-baf"
                          type="default"
                          [visible]="showBAFButton"
                          text="Bon à facturer"
                          (onClick)="bonAFacturer()"
                        ></dx-button>
                        <app-grid-marge [ordre]="data"></app-grid-marge>
                      </div>
                      <div class="grid-separator"></div>
                      <app-grid-lignes-totaux-detail
                        [ordre]="data"
                      ></app-grid-lignes-totaux-detail>
                      <div class="grid-separator"></div>
                      <app-grid-detail-palettes
                        [ordre]="data"
                      ></app-grid-detail-palettes>
                    </div>
                  </div>
                </dx-accordion>
              </div>

              <div
                class="fluxdocs-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <dx-accordion
                  #anchor
                  [disabled]="!ordre?.id"
                  [attr.data-fragment-id]="fragments.Flux"
                  data-name="fluxdocs"
                  [collapsible]="true"
                  [multiple]="false"
                  [selectedIndex]="-1"
                  [dataSource]="[ordre]"
                  (onItemClick)="onAccordionToggleBtnClick($event)"
                >
                  <div *dxTemplate="let prop of 'title'">
                    <span class="dx-form-group-caption accordion-title">{{
                      "ordres-suivi-groupe-fluxdocs" | localize
                    }}</span>
                  </div>
                  <div *dxTemplate="let data of 'item'">
                    <div [hidden]="!gridCommandes?.gridRowsTotal">
                      <app-actions-documents-ordres
                        [ordre]="data"
                        [gridEnvois]="gridEnvois"
                        [gridCommandes]="gridCommandes"
                        [orderConfirmationOnly]="false"
                      ></app-actions-documents-ordres>
                    </div>
                    <div class="dx-form-group-content">
                      <app-grid-envois [ordre]="data"></app-grid-envois>
                    </div>
                  </div>
                </dx-accordion>
              </div>

              <div
                class="CQ-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <dx-accordion
                  #anchor
                  [disabled]="!ordre?.id"
                  [attr.data-fragment-id]="fragments.CQ"
                  data-name="CQ"
                  [collapsible]="true"
                  [multiple]="false"
                  [selectedIndex]="-1"
                  [dataSource]="[ordre]"
                  (onItemClick)="onAccordionToggleBtnClick($event)"
                >
                  <div *dxTemplate="let prop of 'title'">
                    <span class="dx-form-group-caption accordion-title">{{
                      "ordres-suivi-groupe-CQ" | localize
                    }}</span>
                  </div>
                  <div *dxTemplate="let data of 'item'">
                    <div class="dx-form-group-content">
                      <app-grid-controle-qualite
                        [ordre]="data"
                      ></app-grid-controle-qualite>
                    </div>
                  </div>
                </dx-accordion>
              </div>

              <div
                class="commentaires-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <dx-accordion
                  #anchor
                  [disabled]="!ordre?.id"
                  [attr.data-fragment-id]="fragments.Commentaires"
                  data-name="commentaires"
                  [collapsible]="true"
                  [multiple]="false"
                  [selectedIndex]="-1"
                  [dataSource]="[ordre]"
                  (onItemClick)="onAccordionToggleBtnClick($event)"
                >
                  <div *dxTemplate="let prop of 'title'">
                    <span class="dx-form-group-caption accordion-title">{{
                      "ordres-suivi-groupe-commentaires" | localize
                    }}</span>
                  </div>
                  <div *dxTemplate="let data of 'item'">
                    <div class="dx-form-group-content">
                      <app-grid-commentaire-ordre
                        [ordre]="data"
                      ></app-grid-commentaire-ordre>
                    </div>
                  </div>
                </dx-accordion>
              </div>

              <div
                class="log-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings"
              >
                <dx-accordion
                  #anchor
                  [disabled]="!ordre?.id"
                  [attr.data-fragment-id]="fragments.Log"
                  data-name="log"
                  [collapsible]="true"
                  [multiple]="false"
                  [selectedIndex]="-1"
                  [dataSource]="[ordre]"
                  (onItemClick)="onAccordionToggleBtnClick($event)"
                >
                  <div *dxTemplate="let prop of 'title'">
                    <span class="dx-form-group-caption accordion-title">{{
                      "ordres-suivi-groupe-log" | localize
                    }}</span>
                  </div>
                  <div *dxTemplate="let data of 'item'">
                    <div class="dx-form-group-content">
                      <app-grid-save-log [ordre]="data"></app-grid-save-log>
                    </div>
                  </div>
                </dx-accordion>
              </div>
            </div>
          </dxi-item>
        </dx-box>
      </div>
    </dx-validation-group>
  </form>

  <app-ajout-articles-manu-popup
    [ordre]="ordre"
    [gridCommandes]="gridCommandes"
    [articleRowKey]="articleRowKey"
    [single]="!!articleRowKey"
    (lignesChanged)="onLignesChanged($event)"
  >
  </app-ajout-articles-manu-popup>

  <app-destockage-auto-popup
    [ordreId]="ordre?.id"
    [gridCommandes]="gridCommandes"
    (updateGridCde)="gridCommandes.update()"
  ></app-destockage-auto-popup>

  <app-editing-alert></app-editing-alert>

  <app-file-manager-popup
    key="ordres"
    [subTitle]="'Ordre n°' + ordre.numero"
    [id]="ordre.id"
    *ngIf="ordre"
  >
  </app-file-manager-popup>
  <app-zoom-transporteur-popup
    [transporteurLigneId]="transporteurLigneId"
    [transporteurTitle]="transporteurTitle"
  >
  </app-zoom-transporteur-popup>
  <app-zoom-client-popup
    [clientId]="clientId"
    [clientCode]="clientCode"
    [clientTitle]="clientTitle"
  >
  </app-zoom-client-popup>
  <app-zoom-entrepot-popup
    [entrepotId]="entrepotId"
    [entrepotCode]="entrepotCode"
    [entrepotTitle]="entrepotTitle"
  >
  </app-zoom-entrepot-popup>
</div>
<app-view-document-popup
  [(visible)]="this.factureVisible"
  [document]="this.currentFacture"
></app-view-document-popup>
<app-prompt-popup
  [purpose]="promptPopupPurpose"
  [title]="promptPopupTitle"
  [dateOnly]="promptPopupDateOnly"
  (whenValidate)="onValidatePromptPopup($event)"
></app-prompt-popup>
<app-motif-regularisation-ordre-popup
  (whenQuitRegulPopup)="validateRegulOrder($event)"
></app-motif-regularisation-ordre-popup>
<app-duplication-ordre-popup [ordre]="ordre"></app-duplication-ordre-popup>
<app-groupage-chargements-popup
  [ordre]="ordre"
  [gridCommandes]="gridCommandes"
  [allowMutations]="allowMutations"
  [gridEnvois]="gridEnvois"
  (lignesChanged)="onLignesChanged($event)"
  (ordreChanged)="refreshHeader($event)"
></app-groupage-chargements-popup>
<app-selection-compte-palox-popup
  [ordre]="ordre"
  (selectedClient)="afterSelectPaloxAccounts($event)"
></app-selection-compte-palox-popup>
<app-modif-commande-edi-popup
  [commandeEdiId]="refOrdreEdi"
  [commandeId]="ordre?.id"
  [showMode]="true"
  [canalCde]="canalOrdreEdi"
  [gridCommandes]="gridCommandes"
  [articleRowKey]="articleRowKey"
  [single]="true"
  [fullOrderNumber]="fullOrderNumber"
  [allowMutations]="allowMutations"
  [histoLigneOrdreText]="histoLigneOrdreText"
  [histoLigneOrdreReadOnlyText]="histoLigneOrdreReadOnlyText"
  [ordre]="ordre"
  (lignesChanged)="onLignesChanged($event)"
></app-modif-commande-edi-popup>
<app-confirmation-result-popup></app-confirmation-result-popup>
<app-choix-entrepot-commande-edi-popup
  [clientId]="ordre?.client?.id"
  [title]="'modification-entrepot' | localize"
  (entrepotChosen)="onEntrepotChosen($event)"
>
</app-choix-entrepot-commande-edi-popup>
