<ng-container *ngIf="FEATURE.rowOrdering">
  <dx-button
    [focusStateEnabled]="false"
    class="down-move-button"
    type="normal"
    text="down"
    icon="arrowdown"
    hint="{{ 'hint-deplacer-ligne-bas' | localize }}"
    [disabled]="lastRowFocused || !gridRowsTotal || !allowMutations"
    (onClick)="moveRowUpDown($event)"
  ></dx-button>
  <dx-button
    [focusStateEnabled]="false"
    class="up-move-button"
    type="normal"
    text="up"
    icon="arrowup"
    hint="{{ 'hint-deplacer-ligne-haut' | localize }}"
    [disabled]="!currentfocusedRow || !allowMutations"
    (onClick)="moveRowUpDown($event)"
  ></dx-button>
</ng-container>
<dx-data-grid
  [remoteOperations]="{
    filtering: true
  }"
  [columnAutoWidth]="true"
  [repaintChangesOnly]="true"
  [highlightChanges]="true"
  [focusedRowEnabled]="FEATURE.rowOrdering"
  [focusedRowIndex]="FEATURE.rowOrdering && 0"
  (onToolbarPreparing)="gridConfigHandler($event)"
  (onSaving)="onSaving($event)"
  (focusedColumnIndexChange)="focusedColumnIndexChange()"
  (onCellPrepared)="FEATURE.highlightBio && onCellPrepared($event)"
  (onFocusedRowChanged)="FEATURE.rowOrdering && onFocusedRowChanged($event)"
  (onContentReady)="FEATURE.rowOrdering && onContentReady()"
  (onEditorPrepared)="FEATURE.rowOrdering && onEditorPrepared($event)"
>
  <dxo-editing
    [selectTextOnEditStart]="true"
    [mode]="'batch'"
    [allowUpdating]="allowMutations"
    [allowDeleting]="allowMutations"
    [(changes)]="changes"
    [refreshMode]="'reshape'"
  ></dxo-editing>
  <dxo-load-panel [enabled]="false"></dxo-load-panel>
  <dxo-keyboard-navigation
    [enterKeyAction]="'moveFocus'"
    [enterKeyDirection]="'column'"
    [editOnKeyPress]="true"
  ></dxo-keyboard-navigation>
  <dxo-summary>
    <dxi-total-item
      column="article.articleDescription.descriptionReferenceLongue"
      summaryType="count"
      displayFormat="{0} ligne(s)"
    ></dxi-total-item>
    <dxi-total-item
      column="nombrePalettesCommandees"
      summaryType="sum"
      displayFormat="{0}"
    ></dxi-total-item>
    <dxi-total-item
      column="nombreColisCommandes"
      summaryType="sum"
      displayFormat="{0}"
    ></dxi-total-item>
  </dxo-summary>

  <!-- certifications -->
  <ng-container *ngIf="FEATURE.columnCertifications">
    <dxi-column
      *ngIf="allowMutations"
      [showInColumnChooser]="false"
      [cellTemplate]="'certificationTemplate'"
    >
    </dxi-column>
    <div *dxTemplate="let cell of 'certificationTemplate'">
      <dx-button
        class="small-article-button certification"
        type="default"
        [focusStateEnabled]="false"
        [text]="showCertificationCheck(cell.data)"
        (onClick)="openCertificationPopup(cell.data)"
      ></dx-button>
    </div>
  </ng-container>

  <!-- origine -->
  <ng-container *ngIf="FEATURE.columnOrigine">
    <dxi-column
      *ngIf="allowMutations"
      [showInColumnChooser]="false"
      [cellTemplate]="'origineTemplate'"
    >
    </dxi-column>
    <div *dxTemplate="let cell of 'origineTemplate'">
      <dx-button
        class="small-article-button origin"
        type="default"
        [focusStateEnabled]="false"
        [visible]="showOriginButton(cell)"
        [text]="showOriginCheck(cell.data)"
        (onClick)="openOriginePopup(cell.data)"
      >
      </dx-button>
    </div>
  </ng-container>

  <!-- switch article -->
  <ng-container *ngIf="FEATURE.quickSwitch">
    <dxi-column
      *ngIf="allowMutations"
      [showInColumnChooser]="false"
      [cellTemplate]="'swapButtonTemplate'"
    >
    </dxi-column>
    <div *dxTemplate="let cell of 'swapButtonTemplate'">
      <dx-button
        class="swap-button"
        type="default"
        [focusStateEnabled]="false"
        icon="material-icons swap_horizontal_circle"
        [disabled]="!allowMutations"
        hint="Remplacer"
        (onClick)="swapArticle(cell.data)"
      ></dx-button>
    </div>
  </ng-container>

  <dxi-column
    *ngFor="let column of this.columns | async"
    [dataField]="column.dataField"
    [allowEditing]="column.allowEditing"
    [allowSorting]="column.allowSorting"
    [cellTemplate]="column.cellTemplate"
    [editCellTemplate]="column.editCellTemplate"
    [calculateDisplayValue]="column?.calculateDisplayValue"
    [caption]="
      ('ordreLignes-' + column.dataField?.split('.').join('-') | localize) ||
      column.name
    "
  >
    <!-- Restrictions valeurs saisies -->
    <dxi-validation-rule
      *ngIf="column.dataField === 'nombrePalettesIntermediaires'"
      type="range"
      [min]="0"
      [max]="9"
      message="{{ 'valeurIncorrecte' | localize }}"
    ></dxi-validation-rule>
    <dxi-validation-rule
      *ngIf="column.dataField === 'nombrePalettesCommandees'"
      type="range"
      [min]="0"
      [max]="999"
      message="{{ 'valeurIncorrecte' | localize }}"
    ></dxi-validation-rule>
    <dxi-validation-rule
      *ngIf="column.dataField === 'nombreColisPalette'"
      type="range"
      [min]="0"
      [max]="999"
      message="{{ 'valeurIncorrecte' | localize }}"
    ></dxi-validation-rule>
    <dxi-validation-rule
      *ngIf="column.dataField === 'nombreColisCommandes'"
      type="range"
      [min]="0"
      [max]="9999"
      message="{{ 'valeurIncorrecte' | localize }}"
    ></dxi-validation-rule>
  </dxi-column>

  <!-- overide mutation buttons -->
  <dxi-column
    *ngIf="allowMutations"
    type="buttons"
    [width]="30"
    [showInColumnChooser]="false"
  ></dxi-column>

  <app-entity-cell-template
    [columnsSettings]="columnsSettings"
  ></app-entity-cell-template>
</dx-data-grid>

<!-- marge previsionelle -->
<app-button-marge-previ
  *ngIf="FEATURE.margePrevisionelle"
  [ordreID]="ordreID"
></app-button-marge-previ>

<app-article-certification-popup
  *ngIf="FEATURE.columnCertifications"
  [ordreLigne]="ordreLigne"
  (changeLigne)="onDataChanged($event)"
></app-article-certification-popup>

<app-article-origine-popup
  *ngIf="FEATURE.columnOrigine"
  [ordreLigne]="ordreLigne"
  (changeLigne)="onDataChanged($event)"
></app-article-origine-popup>
