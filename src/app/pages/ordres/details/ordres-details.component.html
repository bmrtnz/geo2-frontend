<div id="container">

    <dx-button
    class="addTab"
    text="{{ 'btn-neworder' | localize }}"
    icon="add"
    type="default"
    [disabled]="disableButton()"
    (onClick)="pushTab()"

    ></dx-button>
    <div style="clear:both"></div>
</div>
<dx-box>
    <dxi-item [ratio]="0.1"></dxi-item>
    <dxi-item [ratio]="0.7" class="left-buttons-box" [visible]="!this.isIndexTab">
        <dx-button
            class="black"
            data-accordion="articles"
            height="auto"
            icon="box"
            text="{{ 'ordres-details-articles' | localize }}"
            (onClick)="scrollToOnClick($event)">
        </dx-button>
        <dx-button
            class="black"
            data-accordion="logistique"
            height="auto"
            icon="material-icons local_shipping"
            text="{{ 'ordres-details-logistique' | localize }}"
            (onClick)="scrollToOnClick($event)">
        </dx-button>
        <dx-button
            class="black"
            data-accordion="litiges"
            height="auto"
            icon="material-icons offline_bolt"
            (onClick)="scrollToOnClick($event)"
            text="{{ 'ordres-details-litiges' | localize }}">
        </dx-button>
        <dx-button
            class="black"
            data-accordion="marges"
            height="auto"
            icon="material-icons euro_symbol"
            (onClick)="scrollToOnClick($event)"
            text="{{ 'ordres-details-marges' | localize }}">
        </dx-button>
        <dx-button
            class="black"
            height="auto"
            data-accordion="fluxdocs"
            icon="material-icons folder"
            (onClick)="scrollToOnClick($event)"
            text="{{ 'ordres-details-fluxdocs' | localize }}">
        </dx-button>
        <dx-button
            class="black"
            data-accordion="CQ"
            height="auto"
            icon="material-icons insert_chart_outlined"
            (onClick)="scrollToOnClick($event)"
            text="{{ 'ordres-details-CQ' | localize }}">
        </dx-button>
        <dx-button
            class="black"
            data-accordion="commentaires"
            height="auto"
            icon="material-icons message"
            (onClick)="scrollToOnClick($event)"
            text="{{ 'ordres-details-commentaires' | localize }}">
        </dx-button>
        <dx-button
            class="black"
            data-accordion="log"
            height="auto"
            icon="material-icons view_headline"
            (onClick)="scrollToOnClick($event)"
            text="{{ 'ordres-details-log' | localize }}">
        </dx-button>
        <dx-button
            class="black"
            height="auto"
            icon="material-icons folder"
            (onClick)="fileManagerClick()"
            text="{{ 'ordres-details-documents' | localize }}">
        </dx-button>
    </dxi-item>

    <dxi-item [ratio]="8">
        <dx-sortable
            filter=".dx-tab"
            [data]="contents"
            itemOrientation="horizontal"
            dragDirection="horizontal"
            (onDragStart)="onTabDragStart($event)"
            (onReorder)="onTabDrop($event)"
        >

                <dx-tab-panel
                    #tabs
                    [dataSource]="contents"
                    itemTitleTemplate="title"
                    itemTemplate="item"
                    [deferRendering]="false"
                    [showNavButtons]="true"
                    [repaintChangesOnly]="true"
                    (onSelectionChanged)="onSelectionChange($event)"
                    (onTitleRendered)="onTitleRendered($event)"
                >

                    <div *dxTemplate="let content of 'title'; let i = index">
                        <span>{{content.tabTitle}}</span><i *ngIf="i" class="dx-icon dx-icon-close" (click)="closeTab(content)"></i>
                    </div>
                    <div *dxTemplate="let content of 'item'; let i = index">
                        <form
                            [formGroup]="formGroup"
                            (ngSubmit)="onSubmit()"
                        >
                        <dx-validation-group name="loginGroup">
                            <div class="content-block">
                            </div>
                            <div class="content-block details-ordres-page">
                                <dx-box direction="row">
                                    <!-- <dxi-item [ratio]="1" *ngIf="!i">
                                        <dx-button
                                            type="danger"
                                            height="auto"
                                            icon="material-icons dynamic_feed"
                                            text="{{ 'ordres-details-traitmasse' | localize }}"
                                            (onClick)="scrollToOnClick($event)">
                                        </dx-button>
                                    </dxi-item> -->
                                    <!-- <dxi-item [ratio]="0.3" [visible]="this.isIndexTab"> -->
                                    <!-- </dxi-item> -->
                                    <dxi-item [ratio]="8">

                                        <h2 *ngIf="i">
                                            <span class="order-number">{{ content.tabTitle }}</span>
                                            <span>
                                                <span *ngIf="linkedOrdersSearch" class="search-linkedOrders">Recherche ordres liés...</span>
                                                <dx-button *ngFor="let linkedOrder of linkedOrders"
                                                    class="small-button"
                                                    type="default"
                                                    text="{{ linkedOrder.ordre.numero }} ({{ linkedOrder.criteria }})"
                                                    (onClick)="openLinkedOrder(linkedOrder.ordre.id, linkedOrder.ordre.numero, linkedOrder.ordre.campagne)"
                                                >
                                                </dx-button>
                                            </span>
                                        </h2>
                                        <div class="right" *ngIf="i">
                                            <dx-button class="upperButton subButton submit "
                                                type="default"
                                                text="{{ 'btn-valider' | localize }}"
                                                [useSubmitBehavior]="true"
                                            ></dx-button>
                                            <dx-button class="upperButton subButton"
                                                type="danger"
                                                text="{{ 'btn-deleteorder' | localize }}"
                                                (onClick)="onDeleteClick()"
                                            ></dx-button>
                                            <dx-button class="upperButton subButton"
                                                type="default"
                                                text="{{ 'btn-cloneorder' | localize }}"
                                                [disabled]="!canDuplicate"
                                                (onClick)="duplicate()"
                                            ></dx-button>
                                                <dx-button class="upperButton subButton"
                                                type="default"
                                                text="{{ 'btn-complorder' | localize }}"
                                            ></dx-button>

                                        </div>
                                        
                                        <div *ngIf="!i" class="main-search-container">
                                            <dx-box direction="row">
                                            <dxi-item [ratio]="12">
                                                <div class="dx-field">
                                                    <div class="dx-field-label">Rechercher</div>
                                                    <div class="dx-field-value">
                                                        <dx-autocomplete
                                                            placeholder="..."
                                                            [(value)]="numero"
                                                            (onEnterKey)="findOrder($event)"
                                                            (onKeyDown)="hideSearchResults()"
                                                            >
                                                        </dx-autocomplete>
                                                    </div>
                                                </div>
                                            </dxi-item>
                                            <dxi-item [ratio]="1"></dxi-item>
                                            <dxi-item [ratio]="8">
                                                <div class="dx-field">
                                                    <div class="dx-field-label">{{ 'rechOrdres-critere' | localize }}</div>
                                                        <div class="dx-field-value">
                                                        <dx-select-box
                                                            formControlName="search"
                                                            [items]="searchItems"
                                                            [displayExpr]="searchDisplayExpr"
                                                            (valueChange)="changeSearchCriteria()"
                                                        >
                                                        </dx-select-box>
                                                    </div>
                                                </div>
                                            </dxi-item>
                                            </dx-box>
                                        </div>
                                        <app-grid-suivi [filter]="filter" *ngIf="!i && showGridResults" (ordreSelected)="pushTab($event)"></app-grid-suivi>
                                        
                                        <div *ngIf="!i" class="histo-container">
                                            <h2>{{ 'ordres-details-historiqueordres' | localize }}</h2>
                                            <app-grid-historique (ordreSelected)="pushTab($event)"></app-grid-historique>
                                        </div>
                                        <div class="order-tabs" *ngIf="i">
                                            <div class="dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-infos' | localize }}</span>

                                                <div class="dx-form-group-content">
                                                    <dx-box>
                                                        <dxi-item [ratio]="4">
                                                            <!-- Client -->
                                                            <div class="dx-field">
                                                                <div class="dx-field-label">{{ 'ordres-client' | localize }}</div>
                                                                <div class="dx-field-value">
                                                                    <dx-select-box
                                                                      formControlName="client"
                                                                      [dataSource]="clients"
                                                                      displayExpr="raisonSocial"
                                                                      [searchEnabled]="true"
                                                                      [searchExpr]="['id','raisonSocial']"
                                                                    >
                                                                        <dx-validator name="{{ 'ordres-client' | localize }}">
                                                                            <dxi-validation-rule type="required"></dxi-validation-rule>
                                                                        </dx-validator>
                                                                    </dx-select-box>
                                                                </div>
                                                            </div>
                                                            <!-- Réf Client -->
                                                            <div class="dx-field">
                                                                <div class="dx-field-label">{{ 'ordres-referenceClient' | localize }}</div>
                                                                <div class="dx-field-value">
                                                                    <dx-text-box formControlName="referenceClient">
                                                                    <dx-validator name="{{ 'ordres-referenceClient' | localize }}">
                                                                        <dxi-validation-rule type="stringLength" max="70"></dxi-validation-rule>
                                                                    </dx-validator>
                                                                    </dx-text-box>
                                                                </div>
                                                            </div>
                                                            <!-- transporteur -->
                                                            <div class="dx-field">
                                                                <div class="dx-field-label">{{ 'ordres-transporteur' | localize }}</div>
                                                                <div class="dx-field-value">
                                                                    <dx-select-box
                                                                        formControlName="transporteur"
                                                                        [dataSource]="transporteurs"
                                                                        displayExpr="raisonSocial"
                                                                        [searchEnabled]="true"
                                                                        [searchExpr]="['id','raisonSocial']"
                                                                    >
                                                                        <dx-validator name="{{ 'ordres-transporteur' | localize }}">
                                                                            <dxi-validation-rule type="required"></dxi-validation-rule>
                                                                        </dx-validator>
                                                                    </dx-select-box>
                                                                </div>
                                                            </div>
                                                            <!-- commercial -->
                                                            <div class="dx-field">
                                                                <div class="dx-field-label">{{ 'ordres-commercial' | localize }}</div>
                                                                <div class="dx-field-value">
                                                                    <dx-select-box
                                                                        formControlName="commercial"
                                                                        [dataSource]="commercial"
                                                                        displayExpr="nomUtilisateur"
                                                                        [searchEnabled]="true"
                                                                        [searchExpr]="['id','nomUtilisateur']"
                                                                    >
                                                                        <dx-validator name="{{ 'ordres-commercial' | localize }}">
                                                                            <dxi-validation-rule type="required"></dxi-validation-rule>
                                                                        </dx-validator>
                                                                    </dx-select-box>
                                                                </div>
                                                            </div>
                                                            <!-- assistante -->
                                                            <div class="dx-field">
                                                                <div class="dx-field-label">{{ 'ordres-assistante' | localize }}</div>
                                                                <div class="dx-field-value">
                                                                    <dx-select-box
                                                                        formControlName="assistante"
                                                                        [dataSource]="assistante"
                                                                        displayExpr="nomUtilisateur"
                                                                        [searchEnabled]="true"
                                                                        [searchExpr]="['id','nomUtilisateur']"
                                                                    >
                                                                        <dx-validator name="{{ 'ordres-assistante' | localize }}">
                                                                            <dxi-validation-rule type="required"></dxi-validation-rule>
                                                                        </dx-validator>
                                                                    </dx-select-box>
                                                                </div>
                                                            </div>

                                                            <dx-accordion
                                                            [collapsible]="true"
                                                            [multiple]="false"
                                                            [selectedIndex]="-1"
                                                            >
                                                                <dxi-item title="{{ 'ordres-ordrePlus' | localize }}">
                                                                <!-- Ordre + -->
                                                                <!-- <div class="dx-field">
                                                                    <div class="dx-field-label">{{ 'tiers-clients-facturationRaisonSocial' | localize }}</div>
                                                                    <div class="dx-field-value">
                                                                    <dx-text-box formControlName="facturationRaisonSocial">
                                                                        <dx-validator name="{{ 'tiers-entrepots-facturationRaisonSocial' | localize }}">
                                                                        <dxi-validation-rule type="stringLength" max="50"></dxi-validation-rule>
                                                                        </dx-validator>
                                                                    </dx-text-box>
                                                                    </div>
                                                                </div> -->
                                                                </dxi-item>
                                                            </dx-accordion>
                                                            <dx-accordion
                                                            [collapsible]="true"
                                                            [multiple]="false"
                                                            [selectedIndex]="-1"
                                                            >
                                                                <dxi-item title="{{ 'ordres-instructionsLogistiques' | localize }}">
                                                                <!-- Instructions Logistique -->
                                                                <div class="dx-field">
                                                                    <div class="dx-field-label">{{ 'ordres-instructionsLogistiques' | localize }}</div>
                                                                    <div class="dx-field-value">
                                                                    <dx-text-box formControlName="instructionsLogistiques">
                                                                        <dx-validator name="{{ 'ordres-instructionsLogistiques' | localize }}">
                                                                        <dxi-validation-rule type="stringLength" max="50"></dxi-validation-rule>
                                                                        </dx-validator>
                                                                    </dx-text-box>
                                                                    </div>
                                                                </div>
                                                                </dxi-item>
                                                            </dx-accordion>
                                                        </dxi-item>
                                                        <dxi-item [ratio]="1"></dxi-item>
                                                        <dxi-item [ratio]="4">
                                                            <dx-box>
                                                                <dxi-item [ratio]="4">
                                                                    <!-- Date départ -->
                                                                    <div class="dx-field">
                                                                        <div class="dx-field-label">{{ 'ordres-dateDepartPrevue' | localize }}</div>
                                                                        <div class="dx-field-value">
                                                                            <dx-date-box formControlName="dateDepartPrevue"
                                                                            dateSerializationFormat="yyyy-MM-dd"
                                                                            type="date">
                                                                            <dx-validator name="{{ 'ordres-dateDepartPrevue' | localize }}">
                                                                                <dxi-validation-rule type="required"></dxi-validation-rule>
                                                                            </dx-validator>
                                                                            </dx-date-box>
                                                                        </div>
                                                                    </div>
                                                                </dxi-item>
                                                                <dxi-item [ratio]="1"></dxi-item>
                                                                <dxi-item [ratio]="4">
                                                                    <!-- Date livraison -->
                                                                    <div class="dx-field">
                                                                        <div class="dx-field-label">{{ 'ordres-dateLivraisonPrevue' | localize }}</div>
                                                                        <div class="dx-field-value">
                                                                            <dx-date-box formControlName="dateLivraisonPrevue"
                                                                            dateSerializationFormat="yyyy-MM-dd"
                                                                            type="date">
                                                                            <dx-validator name="{{ 'ordres-dateLivraisonPrevue' | localize }}">
                                                                                <dxi-validation-rule type="required"></dxi-validation-rule>
                                                                            </dx-validator>
                                                                            </dx-date-box>
                                                                        </div>
                                                                    </div>
                                                                </dxi-item>
                                                            </dx-box>

                                                            <dx-box>
                                                                <dxi-item [ratio]="4">
                                                                    <!-- Vente Commission -->
                                                                    <div class="dx-field field-large">
                                                                        <div class="dx-field-label checkbox-label">{{ 'ordres-venteACommission' | localize }}</div>
                                                                        <div class="dx-field-value">
                                                                        <dx-check-box formControlName="venteACommission"></dx-check-box>
                                                                        </div>
                                                                    </div>
                                                                </dxi-item>
                                                                <dxi-item [ratio]="1"></dxi-item>
                                                                <dxi-item [ratio]="4">
                                                                    <!-- Bon à facturer -->
                                                                    <div class="dx-field field-large">
                                                                        <div class="dx-field-label checkbox-label">{{ 'ordres-bonAFacturer' | localize }}</div>
                                                                        <div class="dx-field-value">
                                                                        <dx-check-box formControlName="bonAFacturer"></dx-check-box>
                                                                        </div>
                                                                    </div>
                                                                </dxi-item>
                                                            </dx-box>
                                                            <dx-box>
                                                                <dxi-item [ratio]="4">
                                                                    <!-- Facturé -->
                                                                    <div class="dx-field field-large">
                                                                        <div class="dx-field-label checkbox-label">{{ 'ordres-facture' | localize }}</div>
                                                                        <div class="dx-field-value">
                                                                        <dx-check-box formControlName="facture"></dx-check-box>
                                                                        </div>
                                                                    </div>
                                                                </dxi-item>
                                                                <dxi-item [ratio]="1"></dxi-item>
                                                                <dxi-item [ratio]="4">
                                                                    <!-- EDI -->
                                                                    <div class="dx-field field-large">
                                                                        <div class="dx-field-label checkbox-label">{{ 'ordres-factureEDI' | localize }}</div>
                                                                        <div class="dx-field-value">
                                                                        <dx-check-box formControlName="factureEDI"></dx-check-box>
                                                                        </div>
                                                                    </div>
                                                                </dxi-item>
                                                            </dx-box>
                                                            <dx-box>
                                                                <dxi-item [ratio]="4">
                                                                    <!-- Livré -->
                                                                    <div class="dx-field field-large">
                                                                        <div class="dx-field-label checkbox-label">{{ 'ordres-livre' | localize }}</div>
                                                                        <div class="dx-field-value">
                                                                        <dx-check-box formControlName="livre"></dx-check-box>
                                                                        </div>
                                                                    </div>
                                                                </dxi-item>
                                                                <dxi-item [ratio]="1"></dxi-item>
                                                                <dxi-item [ratio]="4">
                                                                </dxi-item>
                                                            </dx-box>
                                                        </dxi-item>
                                                    </dx-box>

                                                </div>

                                            </div>

                                            <div class="articles-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-articles' | localize }}</span>
                                                <dx-button class="upperButton subButton"
                                                    type="default"
                                                    text="{{ 'btn-stock' | localize }}"
                                                ></dx-button>
                                                <dx-button class="upperButton subButton"
                                                    type="default"
                                                    text="{{ 'btn-historique' | localize }}"
                                                ></dx-button>
                                                <dx-button class="upperButton subButton"
                                                    type="default"
                                                    text="{{ 'btn-manuel' | localize }}"
                                                ></dx-button>
                                                <dx-button class="upperButton subButton shiftedRight"
                                                    type="default"
                                                    height="auto"
                                                    icon="material-icons loupe"
                                                    text="{{ 'btn-detailExp' | localize }}"
                                                ></dx-button>
                                                <div style="clear:both"></div>
                                                <div class="dx-form-group-content">
                                                    <app-grid-lignes [ordre]="getSelectedOrdre()"></app-grid-lignes>
                                                </div>

                                            </div>

                                            <div class="logistique-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-logistique' | localize }}</span>
                                                <dx-accordion
                                                data-name="logistique"
                                                [collapsible]="true"
                                                [multiple]="false"
                                                [selectedIndex]="-1"
                                                >
                                                    <dxi-item>
                                                        <div class="dx-form-group-content">
                                                            <div class="dx-form-group-content">
                                                                <app-grid-logistiques [ordre]="getSelectedOrdre()"></app-grid-logistiques>
                                                            </div>
                                                        </div>
                                                    </dxi-item>
                                                </dx-accordion>
                                            </div>

                                            <div class="litiges-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-litiges' | localize }}</span>
                                                <dx-accordion
                                                data-name="litiges"
                                                [collapsible]="true"
                                                [multiple]="false"
                                                [selectedIndex]="-1"
                                                >
                                                    <dxi-item>
                                                        <div class="dx-form-group-content">
                                                        </div>
                                                    </dxi-item>
                                                </dx-accordion>
                                            </div>

                                            <div class="marges-field accordion3 dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-marges' | localize }}</span>
                                                <dx-accordion
                                                data-name="marges"
                                                [collapsible]="true"
                                                [multiple]="false"
                                                [selectedIndex]="-1"
                                                >
                                                    <dxi-item>
                                                        <div class="dx-form-group-content">
                                                        </div>
                                                    </dxi-item>
                                                </dx-accordion>
                                            </div>

                                            <div class="fluxdocs-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-fluxdocs' | localize }}</span>
                                                <dx-accordion
                                                data-name="fluxdocs"
                                                [collapsible]="true"
                                                [multiple]="false"
                                                [selectedIndex]="-1"
                                                >
                                                    <dxi-item>
                                                        <div class="dx-form-group-content">
                                                        </div>
                                                    </dxi-item>
                                                </dx-accordion>
                                            </div>

                                            <div class="CQ-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-CQ' | localize }}</span>
                                                <dx-accordion
                                                data-name="CQ"
                                                [collapsible]="true"
                                                [multiple]="false"
                                                [selectedIndex]="-1"
                                                >
                                                    <dxi-item>
                                                        <div class="dx-form-group-content">
                                                        </div>
                                                    </dxi-item>
                                                </dx-accordion>
                                            </div>
                                            <div class="commentaires-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-commentaires' | localize }}</span>
                                                <dx-accordion
                                                data-name="commentaires"
                                                [collapsible]="true"
                                                [multiple]="false"
                                                [selectedIndex]="-1"
                                                >
                                                    <dxi-item>
                                                        <dx-data-grid
                                                            id="gridContainer"
                                                            [width]=800
                                                            [dataSource]="commentaires"
                                                            [columns]="['Quand', 'Qui', 'Quoi']"
                                                            [showBorders]="true">

                                                            <dxo-editing
                                                            [allowUpdating]="true"
                                                            [allowDeleting]="true"
                                                            [allowAdding]="true"
                                                            >
                                    >                       </dxo-editing>

                                                        </dx-data-grid>
                                                    </dxi-item>
                                                </dx-accordion>
                                            </div>

                                            <div class="log-field dx-form-group dx-form-group-with-caption dx-card responsive-paddings">
                                                <span class="dx-form-group-caption">{{ 'ordres-details-groupe-log' | localize }}</span>
                                                <dx-accordion
                                                data-name="log"
                                                [collapsible]="true"
                                                [multiple]="false"
                                                [selectedIndex]="-1"
                                                >
                                                    <dxi-item>
                                                        <dx-data-grid
                                                            id="gridContainer"
                                                            [width]=500
                                                            [dataSource]="logs"
                                                            [columns]="['DateHeureSauvegarde', 'Qui']"
                                                            [showBorders]="true">
                                                        </dx-data-grid>
                                                    </dxi-item>
                                                </dx-accordion>
                                            </div>
                                        </div>
                                    </dxi-item>
                                </dx-box>
                            </div>
                        </dx-validation-group>
                        </form>
                    </div>

                </dx-tab-panel>

            </dx-sortable>
    </dxi-item>
</dx-box>

<app-editing-alert></app-editing-alert>
<app-file-manager-popup></app-file-manager-popup>
<dx-popup
  [width]="400"
  [height]="165"
  [showTitle]="false"
  [dragEnabled]="false"
  [closeOnOutsideClick]="true"
  [(visible)]="validationPopupVisible"
>
    <p>Cet ordre va être supprimé, voulez-vous continuer ?</p>
    <br>
    <dx-button type="default" text="Supprimer" (onClick)="deleteClick()"></dx-button>
    <dx-button type="normal" text="Annuler" (onClick)="cancelClick()"></dx-button>
</dx-popup>