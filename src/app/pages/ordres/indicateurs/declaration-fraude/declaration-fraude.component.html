<br />
<dx-form
  [(formData)]="preFilterData"
  labelLocation="left"
>
  <dxi-item
    itemType="group"
    [colCount]="6"
  >
    <dxi-item
      dataField="secteur"
      editorType="dxLookup"
      [isRequired]="true"
      [editorOptions]="{
        dataSource: secteurLookupStore,
        displayExpr: 'id',
        searchExpr: ['id', 'description']
      }"
    >
    </dxi-item>
    <dxi-item
      dataField="client"
      editorType="dxLookup"
      [editorOptions]="{
        dataSource: clientLookupStore,
        showClearButton: true,
        displayExpr: 'code'
      }"
    ></dxi-item>
    <dxi-item
      dataField="entrepot"
      editorType="dxLookup"
      [editorOptions]="{
        dataSource: entrepotLookupStore,
        showClearButton: true,
        displayExpr: 'code'
      }"
    ></dxi-item>
    <dxi-item
      dataField="transporteur"
      editorType="dxLookup"
      [editorOptions]="{
        dataSource: transportLookupStore,
        showClearButton: true,
        displayExpr: 'id'
      }"
    ></dxi-item>
    <dxi-item
      dataField="bureauAchat"
      editorType="dxLookup"
      [editorOptions]="{
        dataSource: bureauAchatLookupStore,
        showClearButton: true,
        displayExpr: 'id'
      }"
    ></dxi-item>
    <dxi-item
      dataField="fourniseur"
      editorType="dxLookup"
      [editorOptions]="{
        dataSource: fournisseurLookupStore,
        showClearButton: true,
        displayExpr: 'code'
      }"
    ></dxi-item>
  </dxi-item>
  <dxi-item
    itemType="group"
    [colCount]="3"
  >
    <dxi-item name="periode">
      <dxo-label [text]="'Période'"></dxo-label>
      <div *dxTemplate>
        <dx-select-box
          [items]="periodes"
          [value]="periodes[1]"
          (onValueChanged)="setDates($event)"
        ></dx-select-box>
      </div>
    </dxi-item>
    <dxi-item
      dataField="dateDepartPrevue"
      editorType="dxDateBox"
      [isRequired]="true"
      [editorOptions]="{
        displayFormat: 'dd/MM/yyyy',
        onValueChanged: manualDate.bind(this)
      }"
    ></dxi-item>
    <dxi-item
      dataField="dateLivraisonPrevue"
      editorType="dxDateBox"
      [isRequired]="true"
      [editorOptions]="{
        displayFormat: 'dd/MM/yyyy',
        onValueChanged: manualDate.bind(this)
      }"
    ></dxi-item>
  </dxi-item>
  <dxi-item
    itemType="group"
    [colCount]="2"
  >
    <dxo-label [text]="'Filtrer les ordres modifiés depuis : '"></dxo-label>
    <dxi-item
      dataField="dateModification"
      editorType="dxDateBox"
      [editorOptions]="{
        displayFormat: 'dd/MM/yyyy HH:mm',
        showClearButton: true,
        type: 'datetime'
      }"
    >
      <dxo-label [visible]="false"></dxo-label>
    </dxi-item>
    <dxi-item
      itemType="button"
      verticalAlignment="center"
      [buttonOptions]="{
        type: 'default',
        text: 'btn-launch' | localize,
        onClick: applyPrefilter.bind(this)
      }"
    ></dxi-item>
  </dxi-item>
</dx-form>
<br />
<dx-data-grid
  [dataSource]="dataSource"
  [width]="'100%'"
  (onRowPrepared)="onRowPrepared($event)"
>
  <dxo-grouping></dxo-grouping>
  <dxo-export [enabled]="true"></dxo-export>
  <dxi-column
    [dataField]="'dateDepartPrevueFournisseur'"
    [groupIndex]="0"
    [dataType]="'date'"
    [groupCellTemplate]="'groupDPFTemplate'"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'numeroOrdre'"
    [groupIndex]="1"
    [groupCellTemplate]="'groupOrdreTemplate'"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'fournisseurCode'"
    [caption]="'fraude-column-fournisseurCode' | localize"
    [groupIndex]="2"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'dateDepartPrevue'"
    [caption]="'fraude-column-dateDepartPrevue' | localize"
    [dataType]="'date'"
    [format]="'dd/MM'"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'dateDepartPrevueFournisseur'"
    [caption]="'fraude-column-dateDepartPrevueFournisseur' | localize"
    [dataType]="'date'"
    [format]="'dd/MM'"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'nombrePalettesCommandees'"
    [caption]="'fraude-column-nombrePalettesCommandees' | localize"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'nombreColisCommandes'"
    [caption]="'fraude-column-nombreColisCommandes' | localize"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'poidsNet'"
    [caption]="'fraude-column-poidsNet' | localize"
    [calculateCellValue]="calculatePoidsNetValue"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'articleDescription'"
    [caption]="'fraude-column-articleDescription' | localize"
    [calculateCellValue]="calculateArticleValue"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'pays'"
    [calculateCellValue]="calculatePaysValue"
    [width]="'auto'"
  ></dxi-column>
  <dxi-column
    [dataField]="'incotermCode'"
    [caption]="'fraude-column-incotermCode' | localize"
    [width]="'auto'"
  ></dxi-column>

  <dxo-summary [recalculateWhileEditing]="true">
    <dxi-group-item
      [showInColumn]="'nombrePalettesCommandees'"
      [displayFormat]="'fraude-total-variete-station' | localize"
      [showInGroupFooter]="true"
    ></dxi-group-item>
    <dxi-group-item
      column="nombreColisCommandes"
      summaryType="sum"
      [showInGroupFooter]="true"
      [displayFormat]="'{0}'"
    >
    </dxi-group-item>
    <dxi-group-item
      column="poidsNet"
      summaryType="sum"
      [showInGroupFooter]="true"
      [displayFormat]="'{0}'"
    >
    </dxi-group-item>
  </dxo-summary>

  <div *dxTemplate="let data of 'groupDPFTemplate'">
    <div>
      {{ "fraude-depart-station" | localize }}
      {{ data.value | date: "dd/MM/yyyy" }}
    </div>
  </div>

  <div *dxTemplate="let data of 'groupOrdreTemplate'">
    <div>
      <span>{{ "order" | localize | titlecase }} : </span>
      {{ data.value }}
      <span>{{ "client" | localize | titlecase }} : </span>
      <span
        >{{ data.data.items[0].items[0].clientCode }} /
        {{ data.data.items[0].items[0].fournisseurCode }}</span
      >
      <span>
        - Ref: ({{
          data.data.items[0].items[0].dateModification
            | date: "dd/MM/yyyy hh:mm:ss"
        }})
      </span>
      <span>
        {{ "transporteur" | localize | titlecase }}:
        {{ data.data.items[0].items[0].transporteurCode }}</span
      >
    </div>
  </div>
</dx-data-grid>
